<!-- Pairs Management Table -->
<div class="table-responsive">
    <table class="table table-hover mb-0">
        <thead class="table-dark">
            <tr>
                <th>Symbol</th>
                <th>Live Trading</th>
                <th>Backtest</th>
                <th>Status</th>
                <th>Price</th>
                <th>Bias</th>
                <th>Signals</th>
                <th>Actions <small class="text-muted">(âš¡=Test, ðŸ“Š=Run, ðŸ”„=Toggle)</small></th>
            </tr>
        </thead>
        <tbody>
            {% for pair in config.pairs %}
            {% set status = pair_statuses.get(pair.symbol) %}
            <tr class="pair-row" data-symbol="{{ pair.symbol }}">
                <td>
                    <strong>{{ pair.symbol }}</strong>
                    <br>
                    <small class="text-muted">{{ pair.timeframe }} â€¢ {{ pair.strategy }}</small>
                </td>
                
                <!-- Live Trading Toggle -->
                <td>
                    <label class="toggle-switch">
                        <input type="checkbox" 
                               {% if pair.enabled %}checked{% endif %}
                               {% if is_running %}disabled{% endif %}
                               hx-post="/api/pairs/{{ pair.symbol }}/toggle-enabled"
                               hx-vals='{"enabled": {% if pair.enabled %}false{% else %}true{% endif %}}'
                               hx-target="#status-alert"
                               hx-swap="innerHTML">
                        <span class="slider"></span>
                    </label>
                    {% if pair.enabled %}
                        <small class="text-success d-block">Enabled</small>
                    {% else %}
                        <small class="text-muted d-block">Disabled</small>
                    {% endif %}
                </td>
                
                <!-- Backtest Status -->
                <td>
                    {% if status and status.backtest_running %}
                        <span class="badge bg-warning">
                            <i class="bi bi-graph-up"></i> Running
                        </span>
                    {% elif pair.backtest_enabled %}
                        <span class="badge bg-info">
                            <i class="bi bi-graph-up"></i> Enabled
                        </span>
                    {% else %}
                        <span class="text-muted">Disabled</span>
                    {% endif %}
                </td>
                
                <!-- Status -->
                <td>
                    {% if status %}
                        <span class="status-indicator status-{{ status.status }}"></span>
                        <span class="badge bg-{{ 'success' if status.status == 'running' else 'warning' if status.status == 'starting' else 'secondary' }}">
                            {{ status.status.title() }}
                        </span>
                        {% if status.backtest_running %}
                            <br><small class="text-info"><i class="bi bi-graph-up"></i> Backtesting...</small>
                        {% endif %}
                        {% if status.websocket_connected %}
                            <br><small class="text-success"><i class="bi bi-wifi"></i> Connected</small>
                        {% endif %}
                    {% else %}
                        <span class="status-indicator status-stopped"></span>
                        <span class="badge bg-secondary">Stopped</span>
                    {% endif %}
                </td>
                
                <!-- Current Price -->
                <td>
                    {% if status and status.current_price %}
                        <strong>${{ "%.2f"|format(status.current_price) }}</strong>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                
                <!-- HTF Bias -->
                <td>
                    {% if status and status.htf_bias %}
                        {% set bias_color = 'success' if status.htf_bias == 'bull' else 'danger' if status.htf_bias == 'bear' else 'secondary' %}
                        <span class="badge bg-{{ bias_color }}">
                            {% if status.htf_bias == 'bull' %}
                                <i class="bi bi-arrow-up"></i> Bull
                            {% elif status.htf_bias == 'bear' %}
                                <i class="bi bi-arrow-down"></i> Bear
                            {% else %}
                                <i class="bi bi-dash"></i> Neutral
                            {% endif %}
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">
                            <i class="bi bi-dash"></i> Neutral
                        </span>
                    {% endif %}
                </td>
                
                <!-- Active Signals -->
                <td>
                    {% if status and status.active_signals > 0 %}
                        <span class="badge bg-primary">{{ status.active_signals }}</span>
                        {% if status.last_signal_time and status.last_signal_time is string %}
                            <br><small class="text-muted">{{ status.last_signal_time[:16] }}</small>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">0</span>
                    {% endif %}
                </td>
                
                <!-- Actions -->
                <td>
                    <div class="btn-group btn-group-sm">
                        <!-- Test Signal button -->
                        <button class="btn btn-outline-info btn-sm" 
                                hx-post="/api/pairs/{{ pair.symbol }}/test-signal"
                                hx-target="#status-alert"
                                hx-swap="innerHTML"
                                hx-indicator="#test-signal-spinner-{{ pair.symbol }}"
                                title="Generate test signal">
                            <span id="test-signal-spinner-{{ pair.symbol }}" class="spinner-border spinner-border-sm d-none me-1"></span>
                            <i class="bi bi-lightning"></i>
                        </button>
                        
                        <!-- Run Backtest button -->
                        <button class="btn btn-outline-success btn-sm" 
                                hx-post="/api/pairs/{{ pair.symbol }}/run-backtest"
                                hx-target="#status-alert"
                                hx-swap="innerHTML"
                                hx-indicator="#backtest-spinner-{{ pair.symbol }}"
                                {% if status and status.backtest_running %}disabled{% endif %}
                                title="Run backtest for {{ pair.symbol }}">
                            <span id="backtest-spinner-{{ pair.symbol }}" class="spinner-border spinner-border-sm d-none me-1"></span>
                            <i class="bi bi-graph-up"></i>
                        </button>
                        
                        <!-- Toggle Backtest Status button -->
                        <button class="btn btn-{{ 'success' if pair.backtest_enabled else 'secondary' }} btn-sm" 
                                hx-post="/api/pairs/{{ pair.symbol }}/toggle-backtest-status"
                                hx-target="#status-alert"
                                hx-swap="innerHTML"
                                title="{{ 'Disable' if pair.backtest_enabled else 'Enable' }} backtest for {{ pair.symbol }}">
                            <i class="bi bi-toggle-{{ 'on' if pair.backtest_enabled else 'off' }}"></i>
                        </button>
                        
                        <!-- Remove button -->
                        <button class="btn btn-outline-danger btn-sm" 
                                onclick="removePairWithConfirmation('{{ pair.symbol }}')"
                                title="Remove pair">
                            <i class="bi bi-trash"></i>
                        </button>
                        
                        <!-- Settings button -->
                        <button class="btn btn-outline-secondary btn-sm" 
                                title="Pair settings">
                            <i class="bi bi-gear"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            
            {% if config.pairs|length == 0 %}
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    No trading pairs configured. Click "Add Pair" to get started.
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

{% if config.pairs|length > 0 %}
<div class="card-footer text-muted">
    <div class="row">
        <div class="col-md-6">
            <small>
                <i class="bi bi-info-circle"></i>
                {{ config.pairs|length }} total pairs â€¢ Max concurrent: {{ config.max_concurrent_pairs }}
            </small>
        </div>
        <div class="col-md-6 text-end">
            <small>
                <i class="bi bi-clock"></i>
                Last updated: {{ moment().format('HH:mm:ss') if moment else 'now' }}
            </small>
        </div>
    </div>
</div>
{% endif %}

<script>
// Enhanced UI management for pairs table
document.addEventListener('DOMContentLoaded', function() {
    // Auto-hide alerts after 5 seconds
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            if (alert && alert.parentNode) {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            }
        }, 5000);
    });
    
    // Add smooth transitions for new rows
    const newRows = document.querySelectorAll('.pair-row');
    newRows.forEach(row => {
        row.classList.add('adding');
        setTimeout(() => row.classList.add('show'), 100);
    });
});

// Function to refresh pairs table
function refreshPairsTable() {
    htmx.ajax('GET', '/pairs-table', {
        target: '#pairs-table',
        swap: 'outerHTML'
    });
}

// Function to remove pair row with animation
function removePairRow(symbol) {
    const row = document.querySelector(`tr[data-symbol="${symbol}"]`);
    if (row) {
        row.classList.add('removing');
        setTimeout(() => {
            row.remove();
            // Check if table is empty and show message
            const tbody = document.querySelector('tbody');
            if (tbody.children.length === 0) {
                location.reload();
            }
        }, 300);
    }
}

// Function to remove pair with confirmation and API call
async function removePairWithConfirmation(symbol) {
    if (confirm(`Are you sure you want to remove ${symbol}?`)) {
        try {
            const response = await fetch(`/api/pairs/${symbol}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Show success message
                const statusAlert = document.getElementById('status-alert');
                if (statusAlert) {
                    statusAlert.innerHTML = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle"></i>
                            <strong>Success!</strong> Removed pair ${symbol}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                }
                
                // Remove row with animation
                removePairRow(symbol);
            } else {
                throw new Error('Failed to remove pair');
            }
        } catch (error) {
            console.error('Error removing pair:', error);
            // Show error message
            const statusAlert = document.getElementById('status-alert');
            if (statusAlert) {
                statusAlert.innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Error!</strong> Failed to remove pair ${symbol}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }
        }
    }
}
</script>
