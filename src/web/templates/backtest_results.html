<!-- Status Alert -->
<div id="status-alert"></div>

<!-- Backtest History Table -->
                        <div class="table-responsive">
    <table class="table table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                <th><i class="bi bi-folder"></i> Type</th>
                <th><i class="bi bi-file"></i> Name</th>
                <th><i class="bi bi-hdd"></i> Size</th>
                <th><i class="bi bi-clock"></i> Modified</th>
                <th><i class="bi bi-gear"></i> Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
            <!-- Cached Data Files -->
            {% for file in cached_files %}
            <tr>
                <td><span class="badge bg-primary">Data</span></td>
                <td><code>{{ file.name }}</code></td>
                <td>{{ file.size }}</td>
                <td>{{ file.modified }}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" 
                            title="Delete cached file"
                            onclick="confirm('Delete {{ file.name }}?') && deleteFile('{{ file.name }}')">
                        <i class="bi bi-trash"></i>
                    </button>
                                        </td>
            </tr>
            {% endfor %}
            
            <!-- Backtest Results -->
            {% for result in backtest_results %}
            <tr>
                <td><span class="badge bg-success">Backtest</span></td>
                <td><strong>{{ result.symbol }}</strong></td>
                <td>{{ result.file_size }}</td>
                <td>{{ result.last_run }}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" 
                            title="View results"
                            onclick="viewBacktestResults('{{ result.symbol }}')">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                    <button class="btn btn-sm btn-outline-danger" 
                            title="Delete results"
                            onclick="confirm('Delete {{ result.symbol }} results?') && deleteBacktestResults('{{ result.symbol }}')">
                        <i class="bi bi-trash"></i>
                                                </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
            
            {% if not cached_files and not backtest_results %}
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-3"></i>
                    <br>No cached data or backtest results found
                    <br><small>Use "Fetch Historical Data" to download data first</small>
                </td>
            </tr>
            {% endif %}
                                </tbody>
                            </table>
                        </div>

<!-- Summary Stats -->
<div class="row mt-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Cached Files</h5>
                <h3 class="text-primary">{{ cached_files|length }}</h3>
                <small class="text-muted">Data files available</small>
                    </div>
                </div>
            </div>
    <div class="col-md-6">
                <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Backtest Results</h5>
                <h3 class="text-success">{{ backtest_results|length }}</h3>
                <small class="text-muted">Symbols analyzed</small>
                    </div>
                </div>
            </div>
        </div>

<script>
function deleteFile(filename) {
    if (confirm(`Delete cached file: ${filename}?`)) {
        fetch(`/api/backtests/data/${filename}`, {
            method: 'DELETE'
        })
        .then(response => response.text())
        .then(html => {
            // Show result message
            document.getElementById('status-alert').innerHTML = html;
            // Refresh the table
            setTimeout(() => {
                htmx.trigger('#backtest-history', 'refresh');
            }, 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete file');
        });
    }
}

function deleteBacktestResults(symbol) {
    if (confirm(`Delete backtest results for ${symbol}?`)) {
        fetch(`/api/backtests/results/${symbol}`, {
            method: 'DELETE'
        })
        .then(response => response.text())
        .then(html => {
            // Show result message
            document.getElementById('status-alert').innerHTML = html;
            // Refresh the table
            setTimeout(() => {
                htmx.trigger('#backtest-history', 'refresh');
            }, 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete backtest results');
        });
    }
}

function viewBacktestResults(symbol) {
    fetch(`/api/backtests/results/${symbol}`)
        .then(response => response.text())
        .then(html => {
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', html);
            
            // Wait for DOM to be ready and then show modal
                setTimeout(() => {
                const modalElement = document.getElementById('resultsModal');
                if (modalElement) {
                    // Check if Bootstrap is available
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    } else {
                        // Fallback: show modal manually
                        modalElement.style.display = 'block';
                        modalElement.classList.add('show');
                        document.body.classList.add('modal-open');
                        
                        // Add backdrop
                        const backdrop = document.createElement('div');
                        backdrop.className = 'modal-backdrop fade show';
                        document.body.appendChild(backdrop);
                        
                        // Close button functionality
                        const closeBtn = modalElement.querySelector('.btn-close, .btn-secondary');
                        if (closeBtn) {
                            closeBtn.onclick = () => {
                                modalElement.style.display = 'none';
                                modalElement.classList.remove('show');
                                document.body.classList.remove('modal-open');
                                if (backdrop.parentNode) {
                                    backdrop.parentNode.removeChild(backdrop);
                                }
                                if (modalElement.parentNode) {
                                    modalElement.parentNode.removeChild(modalElement);
                                }
                            };
                        }
                    }
                } else {
                    console.error('Modal element not found');
                }
            }, 100);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load backtest results');
        });
}
    </script>
